<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Extending fabletools: Models • fabletools</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Extending fabletools: Models">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="fabletools.tidyverts.org" src="https://track.mitchelloharawild.com/js/plausible.js"></script>
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fabletools</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.5.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/extension_models.html">Extending fabletools: Models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/tidyverts/fabletools/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Extending fabletools: Models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverts/fabletools/blob/main/vignettes/extension_models.Rmd" class="external-link"><code>vignettes/extension_models.Rmd</code></a></small>
      <div class="hidden name"><code>extension_models.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://fabletools.tidyverts.org/">fabletools</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Registered S3 method overwritten by 'tsibble':</span></span>
<span><span class="co">#&gt;   method               from </span></span>
<span><span class="co">#&gt;   as_tibble.grouped_df dplyr</span></span></code></pre></div>
<p>Writing a time series model using fabletools provides your model with
many additional features without extra effort. Features that aren’t
model specific are handled by fabletools, allowing you to spend more
time writing methods for your model. Some functionality handled by
fabletools includes:</p>
<ul>
<li>Seamless integration with data manipulation and visualisation tools
from the tidyverse.</li>
<li>Consistent formula interface with other tidy time series
models.</li>
<li>Transformations with automatic back-transformation of response
variables.</li>
<li>Batch modelling of many time series and models with parallel
support.</li>
<li>Accuracy evaluation tools (in-sample, out-of-sample, and cross
validation).</li>
<li>Visualisation functions for decompositions, models, and
forecasts.</li>
<li>Support for ensemble and combination modelling (such as
decomposition forecasting).</li>
<li>Hierarchical, grouped, and temporal reconciliation of
forecasts.</li>
</ul>
<p>The fabletools package promotes consistent interfaces and output
structures that allow various time series models to work well together.
This vignette will guide you through creating a fabletools model, and
provide a glimpse into the steps used to convert user data to modelling
inputs, and modelling outputs to user data.</p>
<p>As an example, we’ll create a fabletools model that uses seasonal
averages: <code>SMEAN()</code>. It can be thought of as a seasonal
version of <code><a href="https://fable.tidyverts.org/reference/MEAN.html" class="external-link">fable::MEAN()</a></code>, which instead of averaging the
entire series, it averages values from each season.</p>
<div class="section level2">
<h2 id="the-model-interface">The model interface<a class="anchor" aria-label="anchor" href="#the-model-interface"></a>
</h2>
<p>Much like cross-sectional models (such as <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>), tidy
time-series models use a formula based interface. Of course not all
arguments need to be specified from within the formula (much like
<code>na.action</code> in <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code>). The model formula is a
familiar and user friendly interface for specifying key model concepts
(like <code>pdq()</code> in <code><a href="https://fable.tidyverts.org/reference/ARIMA.html" class="external-link">ARIMA()</a></code>), and data-varying
inputs (such as holidays and exogenous regressors). Model specific
formula functions (like <code>pdq()</code>) are known as specials (much
like <code>specials</code> from
<code><a href="https://rdrr.io/r/stats/terms.formula.html" class="external-link">stats::terms.formula()</a></code>).</p>
<p>Before writing code, it is a good idea to think about what interface
best suits your model. This is often model specific, however you may
find it useful to look at existing interfaces to see how yours could be
written consistently. A good example of this is with seasonality:
fourier terms are specified with the <code>fourier(period, K)</code>
special, and seasonal dummy variables use
<code>season(period)</code>.</p>
<p>A potential interface for the <code>SMEAN()</code> model could
be:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">SMEAN</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu">season</span><span class="op">(</span><span class="va">period</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="minimum-implementation-of-a-model">Minimum implementation of a model<a class="anchor" aria-label="anchor" href="#minimum-implementation-of-a-model"></a>
</h2>
<p>At minimum, a model consists of a model function (something that
returns a model definition), a set of specials, and a training
function.</p>
<div class="section level3">
<h3 id="the-model-function">The model function<a class="anchor" aria-label="anchor" href="#the-model-function"></a>
</h3>
<p>Model functions typically consist of two function calls. A model
class (defining the training method, the specials, and data checks) with
<code><a href="../reference/new-model-class.html">new_model_class()</a></code>, and <code>new_model_definition</code> to
return the model definition:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Seasonal mean models</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Add the rest of your documentation here.</span></span>
<span><span class="co">#' Typically this includes a "Specials" section</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">SMEAN</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">formula</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create a model class which combines the training method, specials, and data checks</span></span>
<span>  <span class="va">model_smean</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new-model-class.html">new_model_class</a></span><span class="op">(</span><span class="st">"smean"</span>,</span>
<span>    <span class="co"># The training method (more on this later)</span></span>
<span>    train <span class="op">=</span> <span class="va">train_smean</span>,</span>
<span>    <span class="co"># The formula specials (the next section)</span></span>
<span>    specials <span class="op">=</span> <span class="va">specials_smean</span>,</span>
<span>    <span class="co"># Any checks of the unprocessed data, like gaps, ordered, regular, etc.</span></span>
<span>    check <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">.data</span><span class="op">)</span> <span class="op">{</span> </span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">tsibble</span><span class="fu">::</span><span class="fu"><a href="https://tsibble.tidyverts.org/reference/regular.html" class="external-link">is_regular</a></span><span class="op">(</span><span class="va">.data</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Data must be regular"</span><span class="op">)</span> </span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Return a model definition which stores the user's model specification</span></span>
<span>  <span class="fu"><a href="../reference/new-model-class.html">new_model_definition</a></span><span class="op">(</span><span class="va">model_smean</span>, <span class="op">{</span><span class="op">{</span><span class="va">formula</span><span class="op">}</span><span class="op">}</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Anything passed to <code>...</code> of
<code><a href="../reference/new-model-class.html">new_model_definition()</a></code> will be passed onward to the model
training function. Note that the formula needs to be embraced with
<code>{{formula}}</code> in order to allow for non-formula inputs like
<code>SMEAN(y)</code>.</p>
</div>
<div class="section level3">
<h3 id="the-specials">The specials<a class="anchor" aria-label="anchor" href="#the-specials"></a>
</h3>
<p>The specials for a model are created using
<code><a href="../reference/new_specials.html">new_specials()</a></code>. The functions specified here will be used
to compute specials each time the model is provided with new data (model
training, forecasting, refitting, etc.). The results of these functions
will be passed to the subsequent method via the <code>specials</code>
argument (more on this later).</p>
<p>To enable automatic model specification (with <code>SMEAN(y)</code>),
the <code>.required_specials</code> argument will ensure that the
special is called at least once. By setting <code>season()</code> as a
required special, <code>SMEAN(y)</code> will be parsed as
<code>SMEAN(y ~ season())</code>. As no arguments will be provided for
omitted required specials, make sure they have good defaults. The
<code><a href="../reference/freq_tools.html">fabletools::get_frequencies()</a></code> function is a useful helper
for handling seasonal periods, as automatically chooses appropriate
seasonalities when <code>period = NULL</code>, and is able to handle
inputs like <code>period = "week"</code>.</p>
<p>Anything not handled by defined specials will be treated as exogenous
regressors and passed to the <code>xreg()</code> special. That is to say
<code>SMEAN(y ~ season("year") + x)</code> will be parsed as
<code>SMEAN(y ~ season("year") + xreg(x))</code>. The
<code>xreg()</code> special should be defined by all models, even if
your model doesn’t support it.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">specials_smean</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_specials.html">new_specials</a></span><span class="op">(</span></span>
<span>  season <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">period</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Your input handling code here.</span></span>
<span>    <span class="fu"><a href="../reference/freq_tools.html">get_frequencies</a></span><span class="op">(</span><span class="va">period</span>, <span class="va">self</span><span class="op">$</span><span class="va">data</span>, .auto <span class="op">=</span> <span class="st">"smallest"</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  xreg <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># This model doesn't support exogenous regressors, time to error.</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Exogenous regressors aren't supported by `SMEAN()`"</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  <span class="co"># This model requires `season()`</span></span>
<span>  <span class="co"># Adding this allows `SMEAN(y)` to automatically include the `season()` special</span></span>
<span>  .required_specials <span class="op">=</span> <span class="st">"season"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The specials are the only thing needed for the formula to work, as
the fabletools handles the transformations and response variables
specified in the formula’s left side.</p>
</div>
<div class="section level3">
<h3 id="the-training-function">The training function<a class="anchor" aria-label="anchor" href="#the-training-function"></a>
</h3>
<p>This function is used to apply the model definition created by the
model function (<code>SMEAN()</code>) to users data when they use
<code>model(data, SMEAN())</code>.</p>
<p>The <code>.data</code> argument is a single series tsibble (no keys),
representing the parsed left side of the formula. The index of
<code>.data</code> is the time of the measurement, and the measured
variables are the transformed response variable(s).</p>
<p>The <code>specials</code> argument is a list of results from parsing
the specials used in the right side of the formula. The result from the
<code>season()</code> special in <code>SMEAN(y ~ season("year"))</code>
would be accessible from <code>specials$season[[1]]</code>. As specials
can be used more than once, the nth usage of special <code>xyz()</code>
can be accessed with <code>specials$xyz[[n]]</code>.</p>
<p>As mentioned earlier, <code>...</code> will contain additional
parameters passed <code>...</code> of
<code><a href="../reference/new-model-class.html">new_model_definition()</a></code>.</p>
<p>The function should return an S3 object that contains everything you
need for your future methods (such as forecasting, getting fitted
values, refitting, etc.).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train_smean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">.data</span>, <span class="va">specials</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Extract a vector of response data</span></span>
<span>  <span class="va">mv</span> <span class="op">&lt;-</span> <span class="fu">tsibble</span><span class="fu">::</span><span class="fu"><a href="https://tsibble.tidyverts.org/reference/measured-vars.html" class="external-link">measured_vars</a></span><span class="op">(</span><span class="va">.data</span><span class="op">)</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mv</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"SMEAN() is a univariate model."</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">.data</span><span class="op">[[</span><span class="va">mv</span><span class="op">]</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Pull out inputs from the specials</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">specials</span><span class="op">$</span><span class="va">season</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"The `season()` special of `SMEAN()` should only be used once."</span><span class="op">)</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="va">specials</span><span class="op">$</span><span class="va">season</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Compute the seasonal averages</span></span>
<span>  <span class="va">season_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">m</span></span>
<span>  <span class="va">season_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">season_id</span><span class="op">)</span></span>
<span>  <span class="va">season_avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">season_y</span>, FUN <span class="op">=</span> <span class="va">mean</span>, FUN.VALUE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span>, </span>
<span>                       USE.NAMES <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Compute fitted values and residuals</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">season_avg</span><span class="op">[</span><span class="va">season_id</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">e</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">-</span> <span class="va">fit</span></span>
<span>  </span>
<span>  <span class="co"># Create S3 model object</span></span>
<span>  <span class="co"># It should be small, but contain everything needed for methods below</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      coef <span class="op">=</span> <span class="va">season_avg</span>,</span>
<span>      n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>,</span>
<span>      y_name <span class="op">=</span> <span class="va">mv</span>,</span>
<span>      fitted <span class="op">=</span> <span class="va">fit</span>,</span>
<span>      residuals <span class="op">=</span> <span class="va">e</span>,</span>
<span>      sigma2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">e</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="st">"model_smean"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Great, that’s the bare minimum for a model complete with interface
and training method. Let’s try it out.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">tsibbledata</span><span class="fu">::</span><span class="va"><a href="https://tsibbledata.tidyverts.org/reference/aus_production.html" class="external-link">aus_production</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/model.html">model</a></span><span class="op">(</span><span class="fu">SMEAN</span><span class="op">(</span><span class="va">Beer</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fit</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A mable: 1 x 1</span></span></span>
<span><span class="co">#&gt;   `SMEAN(Beer)`</span></span>
<span><span class="co">#&gt;         <span style="color: #949494; font-style: italic;">&lt;model&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>    &lt;modl_smn&gt;</span></span></code></pre></div>
<p>It doesn’t look like much, but it has used the above specials and
training method to compute the seasonal average and store it in the
object. However we can’t see any details about the model yet. To make
the model useful, we’ll need to define some methods.</p>
</div>
</div>
<div class="section level2">
<h2 id="methods-for-models">Methods for models<a class="anchor" aria-label="anchor" href="#methods-for-models"></a>
</h2>
<table class="table">
<colgroup>
<col width="15%">
<col width="21%">
<col width="62%">
</colgroup>
<thead><tr class="header">
<th align="left">Method</th>
<th align="left">Value</th>
<th align="left">Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><code><a href="../reference/model_sum.html">model_sum()</a></code></td>
<td align="left"><code>character(1L)</code></td>
<td align="left">A short summary of the model to display in the
mable</td>
</tr>
<tr class="even">
<td align="left"><code><a href="../reference/report.html">report()</a></code></td>
<td align="left">console output</td>
<td align="left">A detailed summary of the model, similar to
<code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>
</td>
</tr>
<tr class="odd">
<td align="left"><code><a href="https://generics.r-lib.org/reference/equation.html" class="external-link">equation()</a></code></td>
<td align="left">character(1L)</td>
<td align="left">The mathematical equation for the fitted model</td>
</tr>
<tr class="even">
<td align="left"><code><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast()</a></code></td>
<td align="left">distribution</td>
<td align="left">Produce forecasts from the model</td>
</tr>
<tr class="odd">
<td align="left"><code><a href="../reference/stream.html">stream()</a></code></td>
<td align="left">updated model</td>
<td align="left">Extend the fit of the model with additional data</td>
</tr>
<tr class="even">
<td align="left"><code><a href="https://generics.r-lib.org/reference/generate.html" class="external-link">generate()</a></code></td>
<td align="left">tsibble</td>
<td align="left">Generate potential reponse values at certain times from
the model</td>
</tr>
<tr class="odd">
<td align="left"><code><a href="https://generics.r-lib.org/reference/interpolate.html" class="external-link">interpolate()</a></code></td>
<td align="left">tsibble</td>
<td align="left">Interpolate missing values using the model</td>
</tr>
<tr class="even">
<td align="left"><code><a href="https://generics.r-lib.org/reference/refit.html" class="external-link">refit()</a></code></td>
<td align="left">refitted model</td>
<td align="left">Apply the model to a new dataset</td>
</tr>
<tr class="odd">
<td align="left"><code><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy()</a></code></td>
<td align="left">tibble of coefficients</td>
<td align="left">Extract coefficients from the model</td>
</tr>
<tr class="even">
<td align="left"><code><a href="https://generics.r-lib.org/reference/glance.html" class="external-link">glance()</a></code></td>
<td align="left">tibble of statistics</td>
<td align="left">Extract summary statistics from the model</td>
</tr>
<tr class="odd">
<td align="left"><code><a href="https://generics.r-lib.org/reference/augment.html" class="external-link">augment()</a></code></td>
<td align="left">tibble of data</td>
<td align="left">Augment a dataset with information from the model</td>
</tr>
<tr class="even">
<td align="left"><code><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components()</a></code></td>
<td align="left">dable of components</td>
<td align="left">Extract decomposed elements from the model</td>
</tr>
<tr class="odd">
<td align="left"><code><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted()</a></code></td>
<td align="left">numeric</td>
<td align="left">Extract fitted values from the model</td>
</tr>
<tr class="even">
<td align="left"><code><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals()</a></code></td>
<td align="left">numeric</td>
<td align="left">Extract residuals from the model</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom fabletools model_sum</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">model_sum.model_smean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"SMEAN[%i]"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">coef</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">fit</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A mable: 1 x 1</span></span></span>
<span><span class="co">#&gt;   `SMEAN(Beer)`</span></span>
<span><span class="co">#&gt;         <span style="color: #949494; font-style: italic;">&lt;model&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>    &lt;SMEAN[4]&gt;</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom fabletools report</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">report.model_smean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">coef</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Seasonal period:"</span>, <span class="va">m</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Seasonal averages:\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.default.html" class="external-link">print.default</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">coef</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"s"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    print.gap <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"\nsigma^2:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">sigma2</span>, <span class="fl">4</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="../reference/report.html">report</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; Series: Beer </span></span>
<span><span class="co">#&gt; Model: SMEAN[4] </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Seasonal period: 4</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Seasonal averages:</span></span>
<span><span class="co">#&gt;       s1        s2        s3        s4  </span></span>
<span><span class="co">#&gt; 416.8182  372.6182  387.3704  485.4444  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; sigma^2: 5494.6686</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom fabletools tidy</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">tidy.model_smean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    term <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"season_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">coef</span><span class="op">)</span><span class="op">)</span>, </span>
<span>    estimate <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">coef</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 3</span></span></span>
<span><span class="co">#&gt;   .model      term     estimate</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> SMEAN(Beer) season_1     417.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> SMEAN(Beer) season_2     373.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> SMEAN(Beer) season_3     387.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> SMEAN(Beer) season_4     485.</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom fabletools glance</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">glance.model_smean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    sigma2 <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">sigma2</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/glance.html" class="external-link">glance</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 2</span></span></span>
<span><span class="co">#&gt;   .model      sigma2</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> SMEAN(Beer)  <span style="text-decoration: underline;">5</span>495.</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom fabletools forecast</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">forecast.model_smean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">new_data</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Extract required parameters</span></span>
<span>  <span class="va">h</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">new_data</span><span class="op">)</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="va">object</span><span class="op">$</span><span class="va">n</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">coef</span><span class="op">)</span></span>
<span>  <span class="va">coef</span> <span class="op">&lt;-</span> <span class="va">object</span><span class="op">$</span><span class="va">coef</span></span>
<span>  </span>
<span>  <span class="co"># Compute forecast variance</span></span>
<span>  <span class="va">season_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">m</span></span>
<span>  <span class="va">season_e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">residuals</span>, <span class="va">season_id</span><span class="op">)</span></span>
<span>  <span class="va">season_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">season_e</span>, FUN <span class="op">=</span> <span class="va">sd</span>, FUN.VALUE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span>, </span>
<span>                       USE.NAMES <span class="op">=</span> <span class="cn">FALSE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Create forecast distributions</span></span>
<span>  <span class="va">fc_id</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">h</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="va">n</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">m</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">m</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="va">coef</span><span class="op">[</span><span class="va">fc_id</span><span class="op">]</span></span>
<span>  <span class="va">sigma</span> <span class="op">&lt;-</span> <span class="va">season_sd</span><span class="op">[</span><span class="va">fc_id</span><span class="op">]</span></span>
<span>  <span class="fu">distributional</span><span class="fu">::</span><span class="fu"><a href="https://pkg.mitchelloharawild.com/distributional/reference/dist_normal.html" class="external-link">dist_normal</a></span><span class="op">(</span><span class="va">mu</span>, <span class="va">sigma</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/forecast.html" class="external-link">forecast</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A fable: 8 x 4 [1Q]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Key:     .model [1]</span></span></span>
<span><span class="co">#&gt;   .model      Quarter</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;qtr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> SMEAN(Beer) 2010 Q3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> SMEAN(Beer) 2010 Q4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> SMEAN(Beer) 2011 Q1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> SMEAN(Beer) 2011 Q2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> SMEAN(Beer) 2011 Q3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> SMEAN(Beer) 2011 Q4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> SMEAN(Beer) 2012 Q1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span> SMEAN(Beer) 2012 Q2</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: Beer &lt;dist&gt;, .mean &lt;dbl&gt;</span></span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom fabletools stream</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">stream.model_smean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">new_data</span>, <span class="va">specials</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Extract a vector of response data</span></span>
<span>  <span class="va">mv</span> <span class="op">&lt;-</span> <span class="fu">tsibble</span><span class="fu">::</span><span class="fu"><a href="https://tsibble.tidyverts.org/reference/measured-vars.html" class="external-link">measured_vars</a></span><span class="op">(</span><span class="va">new_data</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">new_data</span><span class="op">[[</span><span class="va">mv</span><span class="op">]</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Compute the new seasonal averages</span></span>
<span>  <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">coef</span><span class="op">)</span></span>
<span>  <span class="va">season_id</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="va">object</span><span class="op">$</span><span class="va">n</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">m</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">m</span></span>
<span>  <span class="va">season_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">season_id</span><span class="op">)</span></span>
<span>  <span class="va">season_avg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">season_y</span>, FUN <span class="op">=</span> <span class="va">mean</span>, FUN.VALUE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span>, </span>
<span>                       USE.NAMES <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">weight_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">season_y</span>, FUN <span class="op">=</span> <span class="va">length</span>, FUN.VALUE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span>,</span>
<span>                       USE.NAMES <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Update coefficients to include new estimates</span></span>
<span>  <span class="va">weight_orig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">n</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="va">m</span>, <span class="va">m</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">object</span><span class="op">$</span><span class="va">n</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">m</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">m</span> <span class="op">-</span> <span class="va">object</span><span class="op">$</span><span class="va">n</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">m</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">new_coef</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">coef</span> <span class="op">*</span> <span class="va">weight_orig</span> <span class="op">+</span> <span class="va">season_avg</span> <span class="op">*</span> <span class="va">weight_new</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">weight_orig</span> <span class="op">+</span> <span class="va">weight_new</span><span class="op">)</span></span>
<span>  <span class="va">coef_change</span> <span class="op">&lt;-</span> <span class="va">new_coef</span> <span class="op">-</span> <span class="va">object</span><span class="op">$</span><span class="va">coef</span></span>
<span>  </span>
<span>  <span class="co"># Update model</span></span>
<span>  <span class="va">new_fits</span> <span class="op">&lt;-</span> <span class="va">new_coef</span><span class="op">[</span><span class="va">season_id</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">new_e</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">-</span> <span class="va">new_fits</span></span>
<span>  <span class="va">object</span><span class="op">$</span><span class="va">coef</span> <span class="op">&lt;-</span> <span class="va">new_coef</span></span>
<span>  <span class="va">object</span><span class="op">$</span><span class="va">fitted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">fitted</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep_len</a></span><span class="op">(</span><span class="va">coef_change</span>, <span class="va">object</span><span class="op">$</span><span class="va">n</span><span class="op">)</span>, <span class="va">new_fits</span><span class="op">)</span></span>
<span>  <span class="va">object</span><span class="op">$</span><span class="va">residuals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">residuals</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep_len</a></span><span class="op">(</span><span class="va">coef_change</span>, <span class="va">object</span><span class="op">$</span><span class="va">n</span><span class="op">)</span>, <span class="va">new_e</span><span class="op">)</span></span>
<span>  <span class="va">object</span><span class="op">$</span><span class="va">n</span> <span class="op">&lt;-</span> <span class="va">object</span><span class="op">$</span><span class="va">n</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>  <span class="va">object</span><span class="op">$</span><span class="va">sigma2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">residuals</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Return updated model object</span></span>
<span>  <span class="va">object</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">us_acc_deaths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tsibble.tidyverts.org/reference/as-tsibble.html" class="external-link">as_tsibble</a></span><span class="op">(</span><span class="va">USAccDeaths</span><span class="op">)</span></span>
<span><span class="va">fit_stream</span> <span class="op">&lt;-</span> <span class="va">us_acc_deaths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">60</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/model.html">model</a></span><span class="op">(</span><span class="fu">SMEAN</span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/report.html">report</a></span><span class="op">(</span><span class="va">fit_stream</span><span class="op">)</span></span>
<span><span class="co">#&gt; Series: value </span></span>
<span><span class="co">#&gt; Model: SMEAN[12] </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Seasonal period: 12</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Seasonal averages:</span></span>
<span><span class="co">#&gt;      s1       s2       s3       s4       s5       s6       s7       s8  </span></span>
<span><span class="co">#&gt;  8085.6   7362.2   8116.6   8292.0   9126.2   9627.6  10446.6   9733.6  </span></span>
<span><span class="co">#&gt;      s9      s10      s11      s12  </span></span>
<span><span class="co">#&gt;  8618.4   8974.2   8434.0   8616.8  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; sigma^2: 251827.8712</span></span>
<span></span>
<span><span class="co"># Update the model with new data</span></span>
<span><span class="va">us_acc_deaths_new</span> <span class="op">&lt;-</span> <span class="va">us_acc_deaths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">61</span><span class="op">:</span><span class="fl">72</span><span class="op">)</span></span>
<span><span class="va">fit_stream</span> <span class="op">&lt;-</span> <span class="va">fit_stream</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/stream.html">stream</a></span><span class="op">(</span><span class="va">us_acc_deaths_new</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/report.html">report</a></span><span class="op">(</span><span class="va">fit_stream</span><span class="op">)</span></span>
<span><span class="co">#&gt; Series: value </span></span>
<span><span class="co">#&gt; Model: SMEAN[12] </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Seasonal period: 12</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Seasonal averages:</span></span>
<span><span class="co">#&gt;        s1         s2         s3         s4         s5         s6         s7  </span></span>
<span><span class="co">#&gt;  8044.000   7283.833   8062.333   8275.333   9124.333   9595.333  10452.833  </span></span>
<span><span class="co">#&gt;        s8         s9        s10        s11        s12  </span></span>
<span><span class="co">#&gt;  9749.167   8700.333   8990.167   8467.167   8720.667  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; sigma^2: 222480.9038</span></span>
<span></span>
<span><span class="co"># Check that it matches a model of the full data</span></span>
<span><span class="va">us_acc_deaths</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/model.html">model</a></span><span class="op">(</span><span class="fu">SMEAN</span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/report.html">report</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Series: value </span></span>
<span><span class="co">#&gt; Model: SMEAN[12] </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Seasonal period: 12</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Seasonal averages:</span></span>
<span><span class="co">#&gt;        s1         s2         s3         s4         s5         s6         s7  </span></span>
<span><span class="co">#&gt;  8044.000   7283.833   8062.333   8275.333   9124.333   9595.333  10452.833  </span></span>
<span><span class="co">#&gt;        s8         s9        s10        s11        s12  </span></span>
<span><span class="co">#&gt;  9749.167   8700.333   8990.167   8467.167   8720.667  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; sigma^2: 222480.9038</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom fabletools fitted</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">fitted.model_smean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">object</span><span class="op">$</span><span class="va">fitted</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tsibble: 218 x 3 [1Q]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Key:       .model [1]</span></span></span>
<span><span class="co">#&gt;    .model      Quarter .fitted</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;qtr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> SMEAN(Beer) 1956 Q1    417.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> SMEAN(Beer) 1956 Q2    373.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> SMEAN(Beer) 1956 Q3    387.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> SMEAN(Beer) 1956 Q4    485.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> SMEAN(Beer) 1957 Q1    417.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> SMEAN(Beer) 1957 Q2    373.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> SMEAN(Beer) 1957 Q3    387.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> SMEAN(Beer) 1957 Q4    485.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> SMEAN(Beer) 1958 Q1    417.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> SMEAN(Beer) 1958 Q2    373.</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 208 more rows</span></span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom fabletools residuals</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">residuals.model_smean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">object</span><span class="op">$</span><span class="va">residuals</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tsibble: 218 x 3 [1Q]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Key:       .model [1]</span></span></span>
<span><span class="co">#&gt;    .model      Quarter .resid</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;qtr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> SMEAN(Beer) 1956 Q1  -<span style="color: #BB0000;">133.</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> SMEAN(Beer) 1956 Q2  -<span style="color: #BB0000;">160.</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> SMEAN(Beer) 1956 Q3  -<span style="color: #BB0000;">160.</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> SMEAN(Beer) 1956 Q4  -<span style="color: #BB0000;">177.</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> SMEAN(Beer) 1957 Q1  -<span style="color: #BB0000;">155.</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> SMEAN(Beer) 1957 Q2  -<span style="color: #BB0000;">145.</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> SMEAN(Beer) 1957 Q3  -<span style="color: #BB0000;">151.</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> SMEAN(Beer) 1957 Q4  -<span style="color: #BB0000;">165.</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> SMEAN(Beer) 1958 Q1  -<span style="color: #BB0000;">145.</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> SMEAN(Beer) 1958 Q2  -<span style="color: #BB0000;">140.</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 208 more rows</span></span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom fabletools components</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">components.model_smean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Create a tsibble of the components</span></span>
<span>  <span class="va">dcmp</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    <span class="op">!</span><span class="op">!</span><span class="va">object</span><span class="op">$</span><span class="va">y_name</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span>,</span>
<span>    season <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span>,</span>
<span>    remainder <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Describe how the components combine into other columns</span></span>
<span>  <span class="va">aliases</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/lst.html" class="external-link">lst</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">object</span><span class="op">$</span><span class="va">y_name</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="va">season</span> <span class="op">+</span> <span class="va">remainder</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Define the behaviour of seasonal components</span></span>
<span>  <span class="co"># This is used for automatic modelling of seasonal components in `decomposition_model()`</span></span>
<span>  <span class="co"># It may also be used for plotting in the future.</span></span>
<span>  <span class="va">seasonalities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>season <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">coef</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Return a dable</span></span>
<span>  <span class="fu"><a href="../reference/as-dable.html">as_dable</a></span><span class="op">(</span></span>
<span>    <span class="va">dcmp</span>,</span>
<span>    resp <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/sym.html" class="external-link">sym</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">y_name</span><span class="op">)</span>, method <span class="op">=</span> <span class="fu"><a href="../reference/model_sum.html">model_sum</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span>,</span>
<span>    seasons <span class="op">=</span> <span class="va">seasonalities</span>, aliases <span class="op">=</span> <span class="va">aliases</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/components.html" class="external-link">components</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span> <span class="co"># Need to store index somewhere. This workflow should improve.</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://mitchelloharawild.com" class="external-link">Mitchell O’Hara-Wild</a>, <a href="http://robjhyndman.com" class="external-link">Rob Hyndman</a>, <a href="https://earo.me" class="external-link">Earo Wang</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
